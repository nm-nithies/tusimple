The RecomposeLayerNormFromMulPattern pass detects and replaces ONNX Layer Normalization patterns with optimized LayerNorm or RMSLayerNorm operations, improving performance and reducing computation complexity.


The RecomposeGeluFromMulPattern pass rewrites Gelu activation functions represented as multiplications in ONNX by identifying exact or approximate forms. 
It replaces matched structures with a concise Gelu operation, maintaining the intended behavior of the computational graph.
he RecomposeGeluFromMulPattern pass rewrites GELU (Gaussian Error Linear Unit) operations by identifying ONNXMulOp patterns that match the GELU formula and replacing them with a direct ONNX GELU operation. This optimization simplifies the expression into a single ONNX operation for better execution efficiency.


This pass identifies a pattern of DequantizeLinear + MatMul + QuantizeLinear operations and rewrites it into a more efficient QLinearMatMul operation. 
It optimizes matrix multiplication in quantized neural networks by recomposing these operations into a single fused QLinearMatMul.

*****************************************************************************************************************************************************************************************

This pass rewrites the ONNXSoftmax operation by decomposing it into  ReduceMax, Subtract, Exp, ReduceSum, and Divide Operation. 
It optimizes the softmax computation by explicitly creating these intermediate steps, potentially enhancing performance or enabling further transformations.

This pass fuses Concat, Shape, and Transpose into a custom ONNXConcatShapeTransposeOp

This pass decomposes FusedMatMul into MatMul and Transpose operations with scaling by alpha

This pass converts ONNXInstanceNormalizationOp into LayerNorm, reshaping scale and bias for improved performance.

The SumToAddPattern rewrites ONNXSumOp into multiple ONNXAddOp operations, replacing input summation with individual additions.

The ReplaceCastLikeByCastPattern transforms ONNXCastLikeOp into an appropriate cast operation based on the target type, preserving the output type. It handles both ranked and unranked tensor types, ensuring the output is correctly cast to match the specified target type.

This pass replaces a 1x1 convolution with a matrix multiplication, reshaping inputs and outputs for efficiency. Bias is handled if present.

The provided C++ code parses the Einsum equation and computes the axes for summation and contraction to facilitate the decomposition of the Einsum operation into MatMul and ReduceSum operations.



Pattern 1 transforms ONNXGroupNormalizationOp into LayerNorm.
Pattern 2 transforms ONNXGroupNormalizationV18Op into LayerNorm.






(nnac_python) amajala@us01-arc-speed:/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build $ cmake --build . --target check-mlir
[0/1] Running the MLIR regression tests
                                                                                    -- Testing: 2948 tests, 128 workers --                                                                                   
  0% [------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------]
FAIL: MLIR :: Target/LLVMIR/llvmir.mlir (1877 of 2948)
******************** TEST 'MLIR :: Target/LLVMIR/llvmir.mlir' FAILED ********************
Exit Code: 2

Command Output (stdout):
--
# RUN: at line 1
/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir | /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir
# .---command stderr------------
# | PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.
# | Stack dump:
# | 0.  Program arguments: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir
# | #0 0x0000000001a4ab88 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate+0x1a4ab88)
# | #1 0x0000000001a4854c SignalHandler(int) Signals.cpp:0:0
# | #2 0x00007ffff7bc2b30 __restore_rt sigaction.c:0:0
# `-----------------------------
# error: command failed with exit status: -11
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir
# .---command stderr------------
# | FileCheck error: '<stdin>' is empty.
# | FileCheck command line:  /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir.mlir
# `-----------------------------
# error: command failed with exit status: 2

--

********************
FAIL: MLIR :: Target/LLVMIR/omptarget-depend.mlir (1878 of 2948)
******************** TEST 'MLIR :: Target/LLVMIR/omptarget-depend.mlir' FAILED ********************
Exit Code: 2

Command Output (stdout):
--
# RUN: at line 1
/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir | /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir
# .---command stderr------------
# | PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.
# | Stack dump:
# | 0.  Program arguments: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir
# | #0 0x0000000001a4ab88 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate+0x1a4ab88)
# | #1 0x0000000001a4854c SignalHandler(int) Signals.cpp:0:0
# | #2 0x00007ffff7bc2b30 __restore_rt sigaction.c:0:0
# `-----------------------------
# error: command failed with exit status: -11
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir
# .---command stderr------------
# | FileCheck error: '<stdin>' is empty.
# | FileCheck command line:  /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/omptarget-depend.mlir
# `-----------------------------
# error: command failed with exit status: 2

--

********************
FAIL: MLIR :: Dialect/LLVMIR/call-intrin.mlir (1879 of 2948)
******************** TEST 'MLIR :: Dialect/LLVMIR/call-intrin.mlir' FAILED ********************
Exit Code: 2

Command Output (stdout):
--
# RUN: at line 1
/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file -verify-diagnostics /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir | /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file -verify-diagnostics /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir
# .---command stderr------------
# | PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.
# | Stack dump:
# | 0.  Program arguments: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir -split-input-file -verify-diagnostics /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir
# | #0 0x0000000001a4ab88 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate+0x1a4ab88)
# | #1 0x0000000001a4854c SignalHandler(int) Signals.cpp:0:0
# | #2 0x00007ffff7bc2b30 __restore_rt sigaction.c:0:0
# `-----------------------------
# error: command failed with exit status: -11
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir
# .---command stderr------------
# | FileCheck error: '<stdin>' is empty.
# | FileCheck command line:  /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Dialect/LLVMIR/call-intrin.mlir
# `-----------------------------
# error: command failed with exit status: 2

--

********************
FAIL: MLIR :: Target/LLVMIR/openmp-reduction-sections.mlir (1880 of 2948)
******************** TEST 'MLIR :: Target/LLVMIR/openmp-reduction-sections.mlir' FAILED ********************
Exit Code: 2

Command Output (stdout):
--
# RUN: at line 1
/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir | /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir
# .---command stderr------------
# | PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.
# | Stack dump:
# | 0.  Program arguments: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir
# | #0 0x0000000001a4ab88 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate+0x1a4ab88)
# | #1 0x0000000001a4854c SignalHandler(int) Signals.cpp:0:0
# | #2 0x00007ffff7bc2b30 __restore_rt sigaction.c:0:0
# `-----------------------------
# error: command failed with exit status: -11
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir
# .---command stderr------------
# | FileCheck error: '<stdin>' is empty.
# | FileCheck command line:  /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/openmp-reduction-sections.mlir
# `-----------------------------
# error: command failed with exit status: 2

--

********************
FAIL: MLIR :: Target/LLVMIR/llvmir-intrinsics.mlir (1881 of 2948)
******************** TEST 'MLIR :: Target/LLVMIR/llvmir-intrinsics.mlir' FAILED ********************
Exit Code: 2

Command Output (stdout):
--
# RUN: at line 1
/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir | /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir
# .---command stderr------------
# | PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace.
# | Stack dump:
# | 0.  Program arguments: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate -mlir-to-llvmir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir
# | #0 0x0000000001a4ab88 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/mlir-translate+0x1a4ab88)
# | #1 0x0000000001a4854c SignalHandler(int) Signals.cpp:0:0
# | #2 0x00007ffff7bc2b30 __restore_rt sigaction.c:0:0
# `-----------------------------
# error: command failed with exit status: -11
# executed command: /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir
# .---command stderr------------
# | FileCheck error: '<stdin>' is empty.
# | FileCheck command line:  /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/bin/FileCheck /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/mlir/test/Target/LLVMIR/llvmir-intrinsics.mlir
# `-----------------------------
# error: command failed with exit status: 2

--

********************
********************
Failed Tests (5):
  MLIR :: Dialect/LLVMIR/call-intrin.mlir
  MLIR :: Target/LLVMIR/llvmir-intrinsics.mlir
  MLIR :: Target/LLVMIR/llvmir.mlir
  MLIR :: Target/LLVMIR/omptarget-depend.mlir
  MLIR :: Target/LLVMIR/openmp-reduction-sections.mlir


Testing Time: 5.09s

Total Discovered Tests: 2948
  Unsupported      :  514 (17.44%)
  Passed           : 2428 (82.36%)
  Expectedly Failed:    1 (0.03%)
  Failed           :    5 (0.17%)
FAILED: tools/mlir/test/CMakeFiles/check-mlir /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/tools/mlir/test/CMakeFiles/check-mlir 
cd /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/tools/mlir/test && /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac_python/bin/python3.8 /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/./bin/llvm-lit -sv /remote/us01sgnfs00562/NNSDK/amajala/amajala/nith/nnac/nnac_backend/llvm-project/build/tools/mlir/test
ninja: build stopped: subcommand failed.
